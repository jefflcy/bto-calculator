<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDB BTO Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        html, body {
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        h2 {
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
        }

        h3 {
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 2px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #666;
        }

        .option-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-row .bubble {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
            position: relative;
        }

        .option-row .bubble:hover {
            border-color: #999;
            background: #f5f5f5;
        }

        .option-row .bubble.selected {
            background: #333;
            border-color: #333;
            color: #fff;
        }

        .income-mode-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .income-mode-label {
            font-weight: 600;
            font-size: 14px;
        }

        .income-switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .income-switch .switch-label {
            font-size: 13px;
            color: #333;
            user-select: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 30px;
            flex: 0 0 auto;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #cfcfcf;
            transition: 0.2s;
            border-radius: 999px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            top: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }

        .switch input:checked + .slider {
            background-color: #333;
        }

        .switch input:checked + .slider:before {
            transform: translateX(22px);
        }

        .switch input:focus-visible + .slider {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
        }

        button {
            background: #333;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            background: #555;
        }

        .results {
            margin-top: 30px;
        }

        .result-section {
            background: #fafafa;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 3px solid #333;
        }

        .result-section h3 {
            margin-top: 0;
        }

        .breakdown {
            margin-top: 10px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item.total {
            font-weight: 600;
            font-size: 16px;
            margin-top: 5px;
            padding-top: 10px;
            border-top: 2px solid #333;
        }

        .info-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
            line-height: 1.5;
        }

        .min-income-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .min-income-wrap .tooltip-icon {
            font-size: 14px;
            color: #666;
            line-height: 1;
        }

        .min-income-wrap .tooltip-content {
            display: none;
            position: absolute;
            right: 0;
            bottom: 100%;
            margin-bottom: 6px;
            padding: 10px 12px;
            width: 360px;
            min-width: 260px;
            max-width: min(420px, calc(100vw - 40px));
            font-size: 12px;
            line-height: 1.45;
            color: #333;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            white-space: normal;
        }

        /* Ensure tooltips can overflow their containers */
        .container, .result-section, .breakdown, .breakdown-item, .option-row, .grid {
            overflow: visible;
        }

        .min-income-wrap .tooltip-content .tooltip-line {
            display: block;
            margin-bottom: 10px;
        }

        .min-income-wrap .tooltip-content .tooltip-line:last-child {
            margin-bottom: 0;
        }

        .min-income-wrap:hover .tooltip-content,
        .min-income-wrap.tooltip-open .tooltip-content {
            display: block;
        }

        /* Age bubbles: tooltip behavior */
        .option-row[data-name="age"] .tooltip-icon {
            display: none;
        }

        .option-row[data-name="age"] .min-income-wrap {
            position: static;
        }

        .option-row[data-name="age"] .bubble .tooltip-content {
            display: block; /* base for JS-controlled visibility */
            opacity: 0;
            visibility: hidden;
            z-index: 100;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            right: auto;
            transform: translateX(-50%);
            width: max-content;
            max-width: min(220px, 80vw);
            padding: 8px 12px;
            font-size: 12px;
            line-height: 1.4;
            color: #333;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .option-row[data-name="age"] .min-income-wrap.show .tooltip-content {
            opacity: 1;
            visibility: visible;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
            }
        }

        /* Tooltip alignment classes for smart positioning */
        .min-income-wrap .tooltip-content.align-left {
            left: 0;
            right: auto;
            transform: none;
        }

        .min-income-wrap .tooltip-content.align-right {
            left: auto;
            right: 0;
            transform: none;
        }

        .option-row[data-name="age"] .bubble .tooltip-content.align-left {
            left: 0;
            right: auto;
            transform: none;
        }

        .option-row[data-name="age"] .bubble .tooltip-content.align-right {
            left: auto;
            right: 0;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HDB BTO Payment Calculator</h1>
        <p class="info-text">Calculate your payment breakdown across all three appointments</p>

        <h2>Property Details</h2>
        
        <label for="unitPrice">Unit Price ($)</label>
        <input type="number" id="unitPrice" placeholder="e.g., 450000" min="0" step="1000">

        <div>
            <label for="flatType">Flat Type</label>
            <input type="hidden" id="flatType" value="4rm">
            <div class="option-row" data-name="flatType">
                <span class="bubble" data-value="2rm">2-Room Flexi</span>
                <span class="bubble" data-value="3rm">3-Room</span>
                <span class="bubble selected" data-value="4rm">4-Room</span>
                <span class="bubble" data-value="5rm">5-Room</span>
                <span class="bubble" data-value="3gen">3-Gen</span>
            </div>
        </div>

        <div>
            <label for="scheme">Payment Scheme</label>
            <input type="hidden" id="scheme" value="no-scheme">
            <div class="option-row" data-name="scheme">
                <span class="bubble selected" data-value="no-scheme">No Scheme</span>
                <span class="bubble" data-value="staggered">Staggered Downpayment</span>
                <span class="bubble" data-value="deferred">Deferred Income Assessment</span>
            </div>
        </div>

        <div class="grid">
            <div>
                <label for="loanType">Loan Type</label>
                <input type="hidden" id="loanType" value="hdb">
                <div class="option-row" data-name="loanType">
                    <span class="bubble" data-value="no-loan">No Loan</span>
                    <span class="bubble selected" data-value="hdb">HDB Loan</span>
                    <span class="bubble" data-value="bank">Bank Loan</span>
                </div>
            </div>
            <div>
                <label for="age">Applicant Age</label>
                <input type="hidden" id="age" value="35">
                <div class="option-row" data-name="age">
                    <span class="bubble selected" data-value="35">
                        ≤35
                        <span class="min-income-wrap" style="margin-left: 4px;">
                            <span class="tooltip-icon">&#9432;</span>
                            <span class="tooltip-content">
                                <span class="tooltip-line">23% of wage contributed to OA.</span>
                            </span>
                        </span>
                    </span>
                    <span class="bubble" data-value="45">
                        36–45
                        <span class="min-income-wrap" style="margin-left: 4px;">
                            <span class="tooltip-icon">&#9432;</span>
                            <span class="tooltip-content">
                                <span class="tooltip-line">21% of wage contributed to OA.</span>
                            </span>
                        </span>
                    </span>
                    <span class="bubble" data-value="50">
                        46–50
                        <span class="min-income-wrap" style="margin-left: 4px;">
                            <span class="tooltip-icon">&#9432;</span>
                            <span class="tooltip-content">
                                <span class="tooltip-line">19% of wage contributed to OA.</span>
                            </span>
                        </span>
                    </span>
                    <span class="bubble" data-value="55">
                        51–55
                        <span class="min-income-wrap" style="margin-left: 4px;">
                            <span class="tooltip-icon">&#9432;</span>
                            <span class="tooltip-content">
                                <span class="tooltip-line">15% of wage contributed to OA.</span>
                            </span>
                        </span>
                    </span>
                </div>
            </div>
        </div>

        <button onclick="calculate()">Calculate Payments</button>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        document.querySelectorAll('.option-row').forEach(function(row) {
            var inputId = row.getAttribute('data-name');
            var input = document.getElementById(inputId);
            row.querySelectorAll('.bubble').forEach(function(bubble) {
                bubble.addEventListener('click', function() {
                    row.querySelectorAll('.bubble').forEach(function(b) { b.classList.remove('selected'); });
                    this.classList.add('selected');
                    input.value = this.getAttribute('data-value');
                });
            });
        });

        function calculateBSD(price) {
            let bsd = 0;
            
            if (price <= 180000) {
                bsd = price * 0.01;
            } else if (price <= 360000) {
                bsd = 180000 * 0.01 + (price - 180000) * 0.02;
            } else if (price <= 1000000) {
                bsd = 180000 * 0.01 + 180000 * 0.02 + (price - 360000) * 0.03;
            } else if (price <= 1500000) {
                bsd = 180000 * 0.01 + 180000 * 0.02 + 640000 * 0.03 + (price - 1000000) * 0.04;
            } else if (price <= 3000000) {
                bsd = 180000 * 0.01 + 180000 * 0.02 + 640000 * 0.03 + 500000 * 0.04 + (price - 1500000) * 0.05;
            } else {
                bsd = 180000 * 0.01 + 180000 * 0.02 + 640000 * 0.03 + 500000 * 0.04 + 1500000 * 0.05 + (price - 3000000) * 0.06;
            }
            
            return Math.max(1, Math.floor(bsd));
        }

        // Base HDB conveyancing scale (Items 1, 1a, 1b):
        // First $30,000 @ 9.0 c. per $100 or part thereof
        // Next $30,000 @ 7.2 c. per $100 or part thereof
        // Thereafter @ 6.0 c. per $100 or part thereof
        function calculateConveyancingBase(amount) {
            let fees = 0;

            if (amount <= 30000) {
                const units1 = Math.ceil(amount / 100);
                fees = units1 * 0.09;
            } else if (amount <= 60000) {
                const units1 = Math.ceil(30000 / 100); // 300 units
                const units2 = Math.ceil((amount - 30000) / 100);
                fees = units1 * 0.09 + units2 * 0.072;
            } else {
                const units1 = Math.ceil(30000 / 100); // 300 units
                const units2 = Math.ceil(30000 / 100); // 300 units
                const units3 = Math.ceil((amount - 60000) / 100);
                fees = units1 * 0.09 + units2 * 0.072 + units3 * 0.06;
            }

            // Keep to cents before GST
            return Math.round(fees * 100) / 100;
        }

        // Returns fee inclusive of GST, rounded up to the next whole dollar.
        // For a flat price of $762,280 this gives:
        // - Sale (no loan / HDB loan): $513
        // - Mortgage on 75% bank loan: $388
        function calculateConveyancingFees(amount) {
            const GST_RATE = 0.09;
            const base = calculateConveyancingBase(amount);
            const withGst = base * (1 + GST_RATE);
            return Math.ceil(withGst);
        }

        function getOptionFee(flatType) {
            if (flatType === '2rm') return 500;
            if (flatType === '3rm') return 1000;
            return 2000;
        }

        function getSurveyFees(flatType) {
            const fees = {
                '2rm': 163.50,
                '3rm': 231.60,
                '4rm': 299.75,
                '5rm': 354.25,
                '3gen': 354.25
            };
            return fees[flatType] || 0;
        }

        function getFireInsurance(flatType) {
            const insurance = {
                '3rm': 3.27,
                '4rm': 4.59,
                '5rm': 5.43,
                '3gen': 5.43
            };
            return insurance[flatType] || 0;
        }

        function getOARate(age) {
            if (age <= 35) return 0.23;
            if (age <= 45) return 0.21;
            if (age <= 50) return 0.19;
            if (age <= 55) return 0.15;
            if (age <= 60) return 0.12;
            return 0; // Above 60 not specified, assume 0 for safety or user handling
        }

        let currentMonthlyInstallment = 0;
        let currentIncomeMode = 'msr';

        function formatOAPercent(age) {
            const a = parseInt(age) || 0;
            const rate = getOARate(a);
            if (!a) return null;
            if (!rate) return 'N/A';
            return (rate * 100).toFixed(1).replace('.0', '');
        }

        function updateCpfSwitchLabel() {
            const right = document.getElementById('incomeModeLabelRight');
            if (!right) return;
            const age = document.getElementById('age') ? document.getElementById('age').value : '';
            const pct = formatOAPercent(age);
            if (!pct) {
                right.textContent = 'CPF OA Contributions';
            } else if (pct === 'N/A') {
                right.textContent = 'CPF OA Contributions (N/A)';
            } else {
                right.textContent = `CPF OA Contributions (${pct}%)`;
            }
        }

        function updateMinIncomeDisplay(mode) {
            const ageInput = document.getElementById('age');
            const age = parseInt(ageInput.value) || 0;
            const display = document.getElementById('minIncomeDisplay');
            const label = document.getElementById('minIncomeLabel');
            const tooltipContent = document.getElementById('minIncomeTooltipContent');
            const working = document.getElementById('calculationWorking');
            
            if (!display || !currentMonthlyInstallment) return;

            currentIncomeMode = mode || 'msr';
            const installmentStr = '$' + currentMonthlyInstallment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const tooltipLines = tooltipContent ? tooltipContent.querySelectorAll('.tooltip-line') : null;
            const line0 = tooltipLines && tooltipLines.length ? tooltipLines[0] : null;
            const line1 = tooltipLines && tooltipLines.length > 1 ? tooltipLines[1] : null;

            if (mode === 'msr') {
                display.style.color = '';
                const income = currentMonthlyInstallment / 0.30;
                display.textContent = '$' + income.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                label.textContent = 'Min. Gross Monthly Income (MSR 30%)';
                if (line0) line0.textContent = 'MSR method: assumes monthly instalment is 30% of gross income.';
                if (line1) line1.textContent = 'For joint tenancy, this refers to the total combined income needed.';
                if (working) working.textContent = `Calculation: ${installmentStr} / 30% (MSR)`;
            } else if (mode === 'cpf') {
                updateCpfSwitchLabel();
                if (!age) {
                    display.style.color = '';
                    display.textContent = 'Please enter age';
                    if (line0) line0.textContent = 'Enter age above to estimate CPF OA coverage.';
                    if (line1) line1.textContent = '';
                    if (working) working.textContent = '';
                    return;
                }
                
                const rate = getOARate(age);
                if (rate === 0) {
                     display.style.color = '';
                     display.textContent = 'N/A (Age > 60)';
                     if (line0) line0.textContent = 'CPF OA estimates are not shown for age above 60.';
                     if (line1) line1.textContent = 'CPF usage limits and rules may differ by case.';
                     if (working) working.textContent = '';
                     return;
                }

                const requiredIncome = currentMonthlyInstallment / rate;
                const maxOA = 8000 * rate;
                
                display.textContent = '$' + requiredIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                const ratePercent = (rate * 100).toFixed(1).replace('.0', '');
                if (working) working.textContent = `Calculation: ${installmentStr} / ${ratePercent}% (OA Contribution)`;

                if (currentMonthlyInstallment > maxOA) {
                    display.style.color = '#dc3545';
                    if (line0) line0.textContent = '⚠️ Exceeds the CPF salary ceiling for one person ($8,000 wage).';
                    if (line1) line1.textContent = 'For joint owners, the combined ceiling is higher ($16,000) and may cover it.';
                } else {
                    display.style.color = '';
                    if (line0) line0.textContent = `CPF method: uses OA allocation rate of ${ratePercent}% (age ${age}).`;
                    if (line1) line1.textContent = 'Assumes Ordinary Wages only (excludes bonuses / Additional Wages).';
                }
                
                label.textContent = 'Min. Gross Income (Full CPF Coverage)';
            }
        }

        function calculate() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const flatType = document.getElementById('flatType').value;
            const loanType = document.getElementById('loanType').value;
            const scheme = document.getElementById('scheme').value;
            const age = parseInt(document.getElementById('age').value) || 0;

            if (!unitPrice || !flatType || !loanType) {
                alert('Please fill in all required fields (Unit Price, Flat Type, Loan Type)');
                return;
            }

            const results = document.getElementById('results');
            results.style.display = 'block';
            
            let html = '';

            // First Appointment
            const optionFee = getOptionFee(flatType);
            html += `
                <div class="result-section">
                    <h3>First Appointment (Flat Selection)</h3>
                    <div class="breakdown">
                        <div class="breakdown-item">
                            <span>Option Fee (via NETS)</span>
                            <span>$${optionFee.toLocaleString()}</span>
                        </div>
                        <div class="breakdown-item total">
                            <span>Total Due</span>
                            <span>$${optionFee.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;

            // Second Appointment
            let secondApptTotal = 0;
            let secondApptBreakdown = [];

            if (scheme === 'deferred') {
                // Deferred Income Assessment: treated as "no loan" at 2nd appointment
                // Same across all loan types: 2.5% downpayment + BSD + HDB Conveyancing Fees (Sale) only
                const downpayment = unitPrice * 0.025;
                // For bank loan, show info icon with tooltip about cash requirement
                const downpaymentLabel = loanType === 'bank'
                    ? 'Downpayment (2.5% <span class="min-income-wrap" style="display:inline-flex;align-items:center;gap:2px;cursor:pointer;"><span class="tooltip-icon">&#9432;</span><span class="tooltip-content"><span class="tooltip-line">Assumes 2.5% in cash here.</span></span></span>)'
                    : 'Downpayment (2.5%)';
                secondApptBreakdown.push([downpaymentLabel, downpayment]);
                secondApptBreakdown.push(['Less: Option Fee paid', -optionFee]);
                secondApptTotal += downpayment - optionFee;

                const bsd = calculateBSD(unitPrice);
                secondApptBreakdown.push(['Buyer Stamp Duty', bsd]);
                secondApptTotal += bsd;

                const conveyancingSale = calculateConveyancingFees(unitPrice);
                secondApptBreakdown.push(['HDB Conveyancing Fees (Sale)', conveyancingSale]);
                secondApptTotal += conveyancingSale;

                // No external lawyer legal fees at 2nd appointment under Deferred Income Assessment
            } else {
                if (loanType === 'no-loan') {
                    const downpayment = unitPrice * 0.10;
                    secondApptBreakdown.push(['Downpayment (10%)', downpayment]);
                    secondApptBreakdown.push(['Less: Option Fee paid', -optionFee]);
                    secondApptTotal += downpayment - optionFee;
                } else if (loanType === 'hdb') {
                    let downpaymentPercent = 0.10;
                    if (scheme === 'staggered') downpaymentPercent = 0.05;

                    const downpayment = unitPrice * downpaymentPercent;
                    secondApptBreakdown.push([`Downpayment (${downpaymentPercent * 100}%)`, downpayment]);
                    secondApptBreakdown.push(['Less: Option Fee paid', -optionFee]);
                    secondApptTotal += downpayment - optionFee;
                } else if (loanType === 'bank') {
                    let downpaymentPercent = 0.20;
                    let cashBreakdown = '5% cash + 15% cash/CPF';

                    if (scheme === 'staggered') {
                        downpaymentPercent = 0.10;
                        cashBreakdown = '5% cash + 5% cash/CPF';
                    }

                    const downpayment = unitPrice * downpaymentPercent;
                    // Info icon with tooltip explaining cash/CPF breakdown
                    const downLabel = `Downpayment (${downpaymentPercent * 100}% <span class="min-income-wrap" style="display:inline-flex;align-items:center;gap:2px;cursor:pointer;"><span class="tooltip-icon">&#9432;</span><span class="tooltip-content"><span class="tooltip-line">Assumes ${cashBreakdown} here.</span></span></span>)`;
                    secondApptBreakdown.push([downLabel, downpayment]);
                    secondApptBreakdown.push(['Less: Option Fee paid', -optionFee]);
                    secondApptTotal += downpayment - optionFee;
                }

                const bsd = calculateBSD(unitPrice);
                secondApptBreakdown.push(['Buyer Stamp Duty', bsd]);
                secondApptTotal += bsd;

                // HDB conveyancing fees (inclusive of GST)
                if (loanType === 'bank') {
                    // HDB acting in Sale (based on flat price)
                    const saleConveyancing = calculateConveyancingFees(unitPrice);
                    // HDB acting in Mortgage to bank (based on 75% loan amount)
                    const loanAmountForFees = unitPrice * 0.75;
                    const mortgageConveyancing = calculateConveyancingFees(loanAmountForFees);
                    const totalConveyancing = saleConveyancing + mortgageConveyancing;

                    secondApptBreakdown.push(['HDB Conveyancing Fees (Sale)', saleConveyancing]);
                    secondApptBreakdown.push(['HDB Conveyancing Fees (Mortgage)', mortgageConveyancing]);
                    secondApptBreakdown.push(['Total HDB Conveyancing Fees', totalConveyancing]);
                    secondApptTotal += totalConveyancing;
                } else {
                    // No loan: Acting in Sale of Flat from HDB
                    // HDB loan: Acting in Sale of Flat together with mortgage loan from HDB
                    const conveyancing = calculateConveyancingFees(unitPrice);
                    const label = loanType === 'hdb'
                        ? 'HDB Conveyancing Fees (Sale + HDB Mortgage)'
                        : 'HDB Conveyancing Fees (Sale)';
                    secondApptBreakdown.push([label, conveyancing]);
                    secondApptTotal += conveyancing;
                }

                // No deferred scheme here, so apply lawyer range only for bank loans with standard / staggered schemes
                if (loanType === 'bank') {
                    secondApptBreakdown.push(['Lawyer Legal Fees (estimate)', '2,500 - 3,000', true]);
                }
            }

            let secondApptTotalMin = secondApptTotal;
            let secondApptTotalMax = secondApptTotal;
            if (loanType === 'bank' && scheme !== 'deferred') {
                secondApptTotalMin += 2500;
                secondApptTotalMax += 3000;
            }

            html += `
                <div class="result-section">
                    <h3>Second Appointment (Signing of Lease Agreement)</h3>
                    <p class="info-text">Estimated 6-9 months from First Appointment</p>
                    <div class="breakdown">
            `;

            secondApptBreakdown.forEach(item => {
                if (item[2]) {
                    html += `<div class="breakdown-item"><span>${item[0]}</span><span>${item[1]}</span></div>`;
                } else {
                    html += `<div class="breakdown-item"><span>${item[0]}</span><span>$${typeof item[1] === 'number' ? item[1].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : item[1]}</span></div>`;
                }
            });

            html += `
                        <div class="breakdown-item total">
                            <span>Total Due</span>
                            <span>$${(loanType === 'bank' && scheme !== 'deferred')
                                ? secondApptTotalMin.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' - $' + secondApptTotalMax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                : secondApptTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            }</span>
                        </div>
                    </div>
                </div>
            `;

            // Third Appointment
            let thirdApptTotal = 0;
            let thirdApptBreakdown = [];
            
            if (loanType === 'no-loan') {
                // For no loan:
                // - Standard / staggered schemes use 10% at 2nd appointment → 90% here
                // - Deferred Income Assessment uses 2.5% at 2nd appointment → 97.5% here
                const secondApptDownPercent = scheme === 'deferred' ? 0.025 : 0.10;
                const paymentPercent = 1 - secondApptDownPercent;
                const payment = unitPrice * paymentPercent;
                thirdApptBreakdown.push([`Balance Payment (${paymentPercent * 100}%)`, payment]);
                thirdApptTotal += payment;
            } else if (loanType === 'hdb') {
                let paymentPercent = 0.15;
                if (scheme === 'staggered') paymentPercent = 0.20;
                if (scheme === 'deferred') paymentPercent = 0.225;
                
                const payment = unitPrice * paymentPercent;
                thirdApptBreakdown.push([`Balance Payment (${paymentPercent * 100}%)`, payment]);
                thirdApptTotal += payment;
                
                // HDB Fees
                thirdApptBreakdown.push(['Lease In-Escrow Registration Fees', 38.30]);
                thirdApptBreakdown.push(['Mortgage In-Escrow Registration Fees', 38.30]);
                thirdApptBreakdown.push(['Mortgage Stamp Duty', 500.00]);
                thirdApptTotal += 38.30 + 38.30 + 500.00;
            } else if (loanType === 'bank') {
                let paymentPercent = 0.05;
                
                if (scheme === 'staggered') {
                    paymentPercent = 0.15;
                } else if (scheme === 'deferred') {
                    paymentPercent = 0.225;
                }
                
                const payment = unitPrice * paymentPercent;
                let balanceLabel;
                if (scheme === 'deferred') {
                    // For bank loan under Deferred: clarify that this assumes 2.5% cash already paid at 2nd appointment
                    balanceLabel = 'Balance Payment (22.5% <span class="min-income-wrap" style="display:inline-flex;align-items:center;gap:2px;cursor:pointer;"><span class="tooltip-icon">&#9432;</span><span class="tooltip-content"><span class="tooltip-line">Assumes 2.5% cash paid previously, so 2.5% cash + 20% cash/CPF here.</span></span></span>)';
                } else {
                    balanceLabel = `Balance Payment (${paymentPercent * 100}%)`;
                }
                thirdApptBreakdown.push([balanceLabel, payment]);
                thirdApptTotal += payment;
                
                // Bank Loan Fees
                thirdApptBreakdown.push(['Mortgage In-Escrow Registration Fees', 38.30]);
                thirdApptBreakdown.push(['Mortgage Stamp Duty', 500.00]);
                thirdApptTotal += 38.30 + 500.00;
            }

            // Common fees for all
            const surveyFees = getSurveyFees(flatType);
            const fireInsurance = getFireInsurance(flatType);
            
            thirdApptBreakdown.push(['Survey Fees', surveyFees]);
            thirdApptTotal += surveyFees;
            
            if (fireInsurance > 0) {
                thirdApptBreakdown.push(['Fire Insurance for 5 years', fireInsurance]);
                thirdApptTotal += fireInsurance;
            }

            if (loanType === 'bank') {
                thirdApptBreakdown.push(['SP Water/Electricity Activation', 'Variable', true]);
            }

            html += `
                <div class="result-section">
                    <h3>Third Appointment (Key Collection)</h3>
                    <div class="breakdown">
            `;

            thirdApptBreakdown.forEach(item => {
                if (item[2]) {
                    html += `<div class="breakdown-item"><span>${item[0]}</span><span>${item[1]}</span></div>`;
                } else {
                    html += `<div class="breakdown-item"><span>${item[0]}</span><span>$${typeof item[1] === 'number' ? item[1].toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : item[1]}</span></div>`;
                }
            });

            html += `
                        <div class="breakdown-item total">
                            <span>Total Due</span>
                            <span>$${thirdApptTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                    </div>
                </div>
            `;

            // Summary
            let totalCash = null;
            let totalCashMin = null;
            let totalCashMax = null;

            if (loanType === 'bank' && scheme !== 'deferred') {
                totalCashMin = optionFee + secondApptTotalMin + thirdApptTotal;
                totalCashMax = optionFee + secondApptTotalMax + thirdApptTotal;
            } else {
                totalCash = optionFee + secondApptTotal + thirdApptTotal;
            }

            html += `
                <div class="result-section">
                    <h3>Total Cash Required</h3>
                    <div class="breakdown">
                        <div class="breakdown-item">
                            <span>First Appointment</span>
                            <span>$${optionFee.toLocaleString()}</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Second Appointment</span>
                            <span>$${(loanType === 'bank' && scheme !== 'deferred')
                                ? secondApptTotalMin.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' - $' + secondApptTotalMax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                : secondApptTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            }</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Third Appointment</span>
                            <span>$${thirdApptTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="breakdown-item total">
                            <span>Total</span>
                            <span>$${(loanType === 'bank' && scheme !== 'deferred')
                                ? totalCashMin.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' - $' + totalCashMax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                : totalCash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                            }</span>
                        </div>
                    </div>
                </div>
            `;

            // Loan Eligibility Check (only for HDB/Bank loans)
            if (loanType === 'hdb' || loanType === 'bank') {
                const loanAmount = unitPrice * 0.75; // Max LTV 75%
                const interestRate = loanType === 'hdb' ? 0.026 : 0.016;
                const loanTenureYears = 25; // Standard loan tenure
                const monthlyRate = interestRate / 12;
                const numPayments = loanTenureYears * 12;
                
                // Calculate monthly installment using loan amortization formula
                const monthlyInstallment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                
                currentMonthlyInstallment = monthlyInstallment;
                
                // MSR is 30%, so minimum income = monthly installment / 0.30
                const minMonthlyIncome = monthlyInstallment / 0.30;
                
                const incomeMode = currentIncomeMode || 'msr';
                const rateDisplay = loanType === 'hdb' ? '2.6%' : '1.6%';
                const rateDisclaimerText = loanType === 'bank' ? 'Note: Bank loan interest rates are floating and subject to change. The rate used here (1.6%) is an estimate.' : '';
                const tooltipLines = [
                    'MSR method: assumes monthly instalment is 30% of gross income.',
                    'For joint tenancy, this refers to the total combined income needed.'
                ];
                if (rateDisclaimerText) tooltipLines.push(rateDisclaimerText);
                const tooltipHtml = tooltipLines.map(function(t) { return '<span class="tooltip-line">' + t + '</span>'; }).join('');
                
                html += `
                    <div class="result-section">
                        <h3>Loan Eligibility Check</h3>
                        
                        <div style="margin-bottom: 15px; padding: 10px; background: #eee; border-radius: 4px;">
                            <div class="income-mode-controls">
                                <span class="income-mode-label">Calculate Min. Gross Monthly Income with:</span>
                                <div class="income-switch">
                                    <span class="switch-label" id="incomeModeLabelLeft">MSR (30%)</span>
                                    <label class="switch">
                                        <input type="checkbox" id="incomeModeSwitch" ${incomeMode === 'cpf' ? 'checked' : ''} aria-label="Toggle income mode">
                                        <span class="slider"></span>
                                    </label>
                                    <span class="switch-label" id="incomeModeLabelRight">CPF OA Contributions</span>
                                </div>
                            </div>
                        </div>

                        <div class="breakdown">
                            <div class="breakdown-item">
                                <span>Loan Amount (75% LTV)</span>
                                <span>$${loanAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Interest Rate (${loanTenureYears} years)</span>
                                <span>${rateDisplay}</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Monthly Installment</span>
                                <span>$${monthlyInstallment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="breakdown-item" style="border-bottom: none; padding-top: 0; padding-bottom: 5px;">
                                <span id="calculationWorking" style="font-size: 12px; color: #666; font-style: italic;">Calculation: $${monthlyInstallment.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} / 30% (MSR)</span>
                            </div>
                            <div class="breakdown-item total">
                                <span id="minIncomeLabel">Min. Gross Monthly Income (MSR 30%)</span>
                                <span class="min-income-wrap" id="minIncomeWrap" role="button" tabindex="0" aria-label="Min income details">
                                    <span id="minIncomeDisplay">$${minMonthlyIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                                    <span class="tooltip-icon" aria-hidden="true">&#9432;</span>
                                    <span class="tooltip-content" id="minIncomeTooltipContent">${tooltipHtml}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }

            results.innerHTML = html;

            // Income mode switch
            var incomeModeSwitch = document.getElementById('incomeModeSwitch');
            if (incomeModeSwitch) {
                updateCpfSwitchLabel();
                incomeModeSwitch.addEventListener('change', function() {
                    updateMinIncomeDisplay(incomeModeSwitch.checked ? 'cpf' : 'msr');
                });
                updateMinIncomeDisplay(incomeModeSwitch.checked ? 'cpf' : (currentIncomeMode || 'msr'));
            }

            // Tooltip: tap/click to toggle on mobile, hover on desktop; close on outside click
            var minIncomeWrap = document.getElementById('minIncomeWrap');
            if (minIncomeWrap) {
                minIncomeWrap.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    minIncomeWrap.classList.toggle('tooltip-open');
                });
                minIncomeWrap.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        minIncomeWrap.classList.toggle('tooltip-open');
                    }
                });
            }
            results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        document.addEventListener('click', function(e) {
            var wrap = document.getElementById('minIncomeWrap');
            if (wrap && !wrap.contains(e.target)) wrap.classList.remove('tooltip-open');
        });

        // If age changes after calculation, update CPF toggle label and refresh CPF mode display
        document.querySelectorAll('.option-row').forEach(function(row) {
            var inputId = row.getAttribute('data-name');
            if (inputId !== 'age') return;
            row.querySelectorAll('.bubble').forEach(function(bubble) {
                bubble.addEventListener('click', function() {
                    updateCpfSwitchLabel();
                    if (currentIncomeMode === 'cpf') updateMinIncomeDisplay('cpf');
                });
            });
        });

        // Simple show/hide for age OA tooltips (no delay / animation)
        (function setupAgeTooltips() {
            var ageRow = document.querySelector('.option-row[data-name="age"]');
            if (!ageRow) return;

            // On touch devices, Safari can synthesize mouseenter/mouseleave around taps,
            // which causes tooltips to flash. Only bind hover handlers when hover is real.
            var supportsHover = false;
            try {
                supportsHover = window.matchMedia && window.matchMedia('(hover: hover) and (pointer: fine)').matches;
            } catch (e) {
                supportsHover = false;
            }

            var lastSelectedAge = (document.getElementById('age') && document.getElementById('age').value) || null;

            function closeAllAgeTooltips() {
                ageRow.querySelectorAll('.min-income-wrap.show').forEach(function(w) {
                    w.classList.remove('show');
                });
            }

            ageRow.querySelectorAll('.bubble').forEach(function(bubble) {
                var wrap = bubble.querySelector('.min-income-wrap');
                if (!wrap) return;

                if (supportsHover) {
                    bubble.addEventListener('mouseenter', function() {
                        positionTooltip(wrap);
                        wrap.classList.add('show');
                    });

                    bubble.addEventListener('mouseleave', function() {
                        wrap.classList.remove('show');
                    });
                }

                // Mobile / touch: tap selected age bubble to show / hide tooltip
                bubble.addEventListener('click', function() {
                    var ageVal = bubble.getAttribute('data-value');

                    // If user is changing selection, just close any open tooltip (no flash)
                    if (ageVal && lastSelectedAge !== ageVal) {
                        lastSelectedAge = ageVal;
                        closeAllAgeTooltips();
                        return;
                    }

                    // Toggle tooltip immediately on tap
                    if (wrap.classList.contains('show')) {
                        wrap.classList.remove('show');
                    } else {
                        closeAllAgeTooltips();
                        positionTooltip(wrap);
                        wrap.classList.add('show');
                    }
                });
            });

            // Close age tooltips on outside tap/click
            document.addEventListener('click', function(e) {
                if (!ageRow.contains(e.target)) closeAllAgeTooltips();
            });
        })();

        // Smart tooltip positioning: flip sides if overflowing viewport
        function positionTooltip(wrapEl) {
            var tooltip = wrapEl.querySelector('.tooltip-content');
            if (!tooltip) return;

            // Reset alignment to measure natural position
            tooltip.classList.remove('align-left', 'align-right');
            tooltip.style.left = '';
            tooltip.style.right = '';
            tooltip.style.top = '';
            tooltip.style.bottom = '';
            tooltip.style.transform = '';
            tooltip.style.maxWidth = '';
            tooltip.style.position = '';

            // For age bubbles, use the bubble as positioning reference
            var bubble = wrapEl.closest('.bubble');
            var refEl = bubble || wrapEl;
            var rect = refEl.getBoundingClientRect();
            
            // Temporarily show tooltip to measure width
            var wasHidden = tooltip.style.display === 'none' || getComputedStyle(tooltip).display === 'none';
            if (wasHidden) {
                tooltip.style.visibility = 'hidden';
                tooltip.style.display = 'block';
            }
            var tooltipWidth = tooltip.offsetWidth || 280;
            var tooltipHeight = tooltip.offsetHeight || 40;
            if (wasHidden) {
                tooltip.style.display = '';
                tooltip.style.visibility = '';
            }

            var viewportWidth = window.innerWidth;
            var viewportHeight = window.innerHeight;
            var padding = 15;

            // For breakdown items (2nd/3rd appointment tooltips), clamp tooltip to viewport
            // so it never gets cut off on mobile.
            var inBreakdown = !!wrapEl.closest('.breakdown-item');
            if (inBreakdown) {
                tooltip.style.position = 'fixed';
                tooltip.style.bottom = 'auto';
                tooltip.style.transform = 'none';
                tooltip.style.maxWidth = 'min(360px, calc(100vw - ' + (padding * 2) + 'px))';

                // Re-measure after maxWidth is applied (so clamping uses actual width)
                var wasHidden2 = tooltip.style.display === 'none' || getComputedStyle(tooltip).display === 'none';
                if (wasHidden2) {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.display = 'block';
                }
                tooltipWidth = tooltip.offsetWidth || tooltipWidth;
                tooltipHeight = tooltip.offsetHeight || tooltipHeight;
                if (wasHidden2) {
                    tooltip.style.display = '';
                    tooltip.style.visibility = '';
                }

                // Prefer above; if not enough space, show below.
                var desiredTop = rect.top - tooltipHeight - 10;
                var top = desiredTop;
                if (top < padding) top = rect.bottom + 10;
                if (top + tooltipHeight > viewportHeight - padding) {
                    top = Math.max(padding, viewportHeight - padding - tooltipHeight);
                }

                // Clamp horizontally within viewport.
                // Try to keep it visually anchored to the icon by centering on it.
                var iconCenterX = rect.left + (rect.width / 2);
                var left = iconCenterX - (tooltipWidth / 2);
                var maxLeft = viewportWidth - padding - tooltipWidth;
                if (left < padding) left = padding;
                if (left > maxLeft) left = Math.max(padding, maxLeft);

                tooltip.style.top = top + 'px';
                tooltip.style.left = left + 'px';
                tooltip.style.right = 'auto';
                return;
            }

            // For age bubbles: calculate centered position and check overflow
            var centerX = rect.left + rect.width / 2;
            var tooltipLeft = centerX - tooltipWidth / 2;
            var tooltipRight = centerX + tooltipWidth / 2;

            var overflowsRight = tooltipRight > (viewportWidth - padding);
            var overflowsLeft = tooltipLeft < padding;

            if (overflowsLeft && !overflowsRight) {
                tooltip.classList.add('align-left');
            } else if (overflowsRight && !overflowsLeft) {
                tooltip.classList.add('align-right');
            }
            // If neither or both overflow, keep centered (no class added)
        }

        // Position tooltips on hover/show for all .min-income-wrap elements
        document.addEventListener('mouseenter', function(e) {
            var wrap = e.target.closest('.min-income-wrap');
            if (wrap) positionTooltip(wrap);
        }, true);

        // Also position on click/tap
        document.addEventListener('click', function(e) {
            var wrap = e.target.closest('.min-income-wrap');
            if (wrap) positionTooltip(wrap);
        }, true);

        // Keep breakdown tooltips anchored on scroll/resize (mobile especially).
        // Without this, fixed-position tooltips can "drift" away from the icon while scrolling.
        (function trackBreakdownTooltip() {
            var activeWrap = null;
            var rafId = 0;

            function isWrapTooltipVisible(wrap) {
                if (!wrap) return false;
                var tip = wrap.querySelector('.tooltip-content');
                if (!tip) return false;
                var cs = getComputedStyle(tip);
                return cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';
            }

            function schedule() {
                if (rafId) return;
                rafId = requestAnimationFrame(function() {
                    rafId = 0;
                    if (activeWrap && isWrapTooltipVisible(activeWrap)) {
                        positionTooltip(activeWrap);
                    } else {
                        activeWrap = null;
                    }
                });
            }

            // Capture opens (hover/click) for breakdown tooltips only.
            document.addEventListener('mouseenter', function(e) {
                var wrap = e.target.closest('.min-income-wrap');
                if (!wrap) return;
                if (!wrap.closest('.breakdown-item')) return;
                activeWrap = wrap;
                schedule();
            }, true);

            document.addEventListener('click', function(e) {
                var wrap = e.target.closest('.min-income-wrap');
                if (!wrap) return;
                if (!wrap.closest('.breakdown-item')) return;
                activeWrap = wrap;
                schedule();
            }, true);

            window.addEventListener('scroll', schedule, { passive: true });
            window.addEventListener('resize', schedule);
        })();
    </script>
</body>
</html>
